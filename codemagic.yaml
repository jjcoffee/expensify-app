workflows:
    react-native-android:
        name: React Native Android
        max_build_duration: 120
        instance_type: mac_mini_m1
        environment:
          #android_signing:
          #  - keystore_reference
          #groups:
          #  - google_play # <-- (Includes GCLOUD_SERVICE_ACCOUNT_CREDENTIALS <-- Put your google-services.json)
          vars:
            PACKAGE_NAME: "com.expensify.chat"
          node: v16.11.1
        cache:
          cache_paths:
            - $HOME/.gradle/caches
            - $CM_BUILD_DIR/node_modules
        scripts:
            - name: Install npm dependencies
              script: |
                npm install
            - name: Launch emulator
              script: | 
                cd $ANDROID_HOME/tools
                emulator -avd emulator &
                adb wait-for-device
            - name: Set Android SDK location
              script: |
                echo "sdk.dir=$ANDROID_SDK_ROOT" > "$CM_BUILD_DIR/android/local.properties"            
            - name: Build Android release
              script: |
                npm run android-build
        artifacts:
            - android/app/build/outputs/**/*.aab
    react-native-ios:
        name: React Native iOS
        max_build_duration: 120
        instance_type: mac_mini_m1
        # integrations:
        #   app_store_connect: codemagic
        cache:
          cache_paths:
            - $HOME/.gradle/caches
            - $CM_BUILD_DIR/node_modules
        environment:
          node: v16.15.1
          npm: v8.11.0
          xcode: latest
          cocoapods: default
        scripts:
            - name: Install npm dependencies
              script: |
                brew install nvm && nvm install
                npm install
            - name: Install CocoaPods dependencies
              script: |
                cd ios && pod install && cd ..
            - name: Build ipa for distribution
              script: |
                npm run ios-build
        artifacts:
            - build/ios/ipa/*.ipa
            - /tmp/xcodebuild_logs/*.log
            - $HOME/Library/Developer/Xcode/DerivedData/**/Build/**/*.app
            - $HOME/Library/Developer/Xcode/DerivedData/**/Build/**/*.dSYM
        publishing:
          email:
            recipients:
              - joeld.dev@gmail.com
            notify:
              success: true
              failure: false
          # app_store_connect:
          #   #auth: integration

          #   # Configuration related to App Store (optional)
          #   # Note: This action is performed during post-processing.
          #   submit_to_app_store: false
